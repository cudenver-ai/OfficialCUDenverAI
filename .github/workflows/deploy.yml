name: Deploy Website on Main Push

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîê SSH and Deploy via Docker Compose
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.PROD_HOST }}
          username: opc
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ~/OfficialCUDenverAI  
            git pull origin main
            docker system prune
            docker-compose build
            docker-compose create
            docker-compose start

      - name: üö® Discord Alert on Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{
              "content": "üö® Deployment failed! Check the logs here: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}